name: Examples Execution

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'veld-example/**'
      - 'veld-annotations/**'
      - 'veld-runtime/**'
      - 'veld-processor/**'
      - 'veld-weaver/**'
  pull_request:
    branches: [ main ]
    paths:
      - 'veld-example/**'
      - 'veld-annotations/**'
      - 'veld-runtime/**'
      - 'veld-processor/**'
      - 'veld-weaver/**'
  workflow_dispatch:

jobs:
  build-and-test-examples:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up JDK 11
      uses: actions/setup-java@v4
      with:
        java-version: '11'
        distribution: 'temurin'
        
    - name: Cache Maven packages
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
        
    - name: Compile Veld Framework
      run: |
        cd $GITHUB_WORKSPACE
        # Try to compile the core modules first
        mvn clean compile -pl veld-annotations,veld-runtime,veld-processor,veld-weaver -am -DskipTests=true -q
        
    - name: Compile Veld Example
      run: |
        cd $GITHUB_WORKSPACE
        # Compile the example module
        mvn clean compile -pl veld-example -am -DskipTests=true
        
    - name: Run Veld Examples
      run: |
        cd $GITHUB_WORKSPACE
        # Execute the main example class
        mvn exec:java -pl veld-example -Dexec.mainClass="io.github.yasmramos.veld.example.Main" -q
        
    - name: Test Compilation Success
      run: |
        cd $GITHUB_WORKSPACE
        # Verify that compilation succeeded by checking for class files
        if [ -d "veld-example/target/classes" ]; then
          echo "âœ… Compilation successful - class files found"
          echo "ðŸ“ Class files directory: veld-example/target/classes"
          find veld-example/target/classes -name "*.class" | head -10
        else
          echo "âŒ Compilation failed - no class files found"
          exit 1
        fi
        
    - name: Verify @DependsOn Examples
      run: |
        cd $GITHUB_WORKSPACE
        # Check that @DependsOn example classes exist
        if [ -f "veld-example/target/classes/io/github/yasmramos/veld/example/dependsOn/DependsOnDemo.class" ]; then
          echo "âœ… @DependsOn examples compiled successfully"
        else
          echo "âŒ @DependsOn examples not found"
          exit 1
        fi
        
    - name: Check for Dependencies
      run: |
        cd $GITHUB_WORKSPACE
        # List key component classes that should exist
        echo "ðŸ” Verifying key component classes:"
        find veld-example/target/classes -name "*ConfigService.class" && echo "âœ… ConfigService found"
        find veld-example/target/classes -name "*DatabaseService.class" && echo "âœ… DatabaseService found"
        find veld-example/target/classes -name "*UserRepository.class" && echo "âœ… UserRepository found"
        find veld-example/target/classes -name "*EmailService.class" && echo "âœ… EmailService found"
        find veld-example/target/classes -name "*UserService.class" && echo "âœ… UserService found"
        
    - name: Upload Example Compilation Artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: veld-example-compilation
        path: |
          veld-example/target/classes/
          veld-example/target/test-classes/
        retention-days: 7
        
    - name: Summary
      run: |
        echo "## ðŸ“‹ Examples Workflow Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### âœ… Compilation Status" >> $GITHUB_STEP_SUMMARY
        echo "- Veld Framework core modules: **Compiled**" >> $GITHUB_STEP_SUMMARY
        echo "- Veld Example module: **Compiled**" >> $GITHUB_STEP_SUMMARY
        echo "- @DependsOn examples: **Available**" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“ Key Components Verified" >> $GITHUB_STEP_SUMMARY
        echo "- ConfigService: âœ…" >> $GITHUB_STEP_SUMMARY
        echo "- DatabaseService: âœ…" >> $GITHUB_STEP_SUMMARY
        echo "- UserRepository (with @DependsOn): âœ…" >> $GITHUB_STEP_SUMMARY
        echo "- EmailService (with @DependsOn): âœ…" >> $GITHUB_STEP_SUMMARY
        echo "- UserService (with multiple @DependsOn): âœ…" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸŽ¯ Demo Features" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… @DependsOn with single dependency" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… @DependsOn with multiple dependencies" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Ordered initialization demonstration" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… Dependency validation" >> $GITHUB_STEP_SUMMARY